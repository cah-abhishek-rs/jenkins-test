pipeline {
    agent {
        kubernetes {
            yaml '''
        apiVersion: v1
        kind: Pod
        metadata:
          labels:
            name: dpp-jenkins-agent
        spec:
          containers:
          - name: dpp-mx-jenkins-iac-agent
            image: 998585994771.dkr.ecr.us-east-1.amazonaws.com/dpp-mx-jenkins-iac-agent:latest
            command:
            - cat
            tty: true
            volumeMounts:
              - name: dockersock
                mountPath: "/var/run/docker.sock"
          - name: dpp-mx-jenkins-app-agent
            image: 998585994771.dkr.ecr.us-east-1.amazonaws.com/dpp-mx-jenkins-app-agent:latest
            command:
            - cat
            tty: true
            volumeMounts:
              - name: dockersock
                mountPath: "/var/run/docker.sock"
          volumes:
            - name: dockersock
              hostPath:
                path: /var/run/docker.sock
      '''
        }
    }

    parameters {
        choice(name: 'ENV', choices: ['dev', 'uat', 'prod'], description: 'Selected environment for deployment')
    }

    environment {
        ENV                   = 'dev'
        GIT_BRANCH            = "${env.GIT_BRANCH}"
        GIT_COMMIT_ID         = "${env.GIT_COMMIT}"
        PROJECT               = "dpp-mx-digital-pharmacy-gateway"
        AWS_ACCESS_KEY_ID     = credentials('DPP_AWS_SECRET_ACCESS_ID')
        AWS_SECRET_ACCESS_KEY = credentials('DPP_AWS_SECRET_ACCESS_KEY')
        AWS_REGION            = 'us-east-1'
        EKS_CLUSTER_NAME      = "digital-pharmacy-dev-cluster"
        ADC_DOCKER_USER       = credentials('DPP_MX_ART_SA_USER')
        ADC_DOCKER_PASSWORD   = credentials('DPP_MX_ART_SA_PASS')
        VERACODE_API_ID       = credentials('VERACODE_API_ID')
        VERACODE_API_KEY      = credentials('VERACODE_API_KEY')
        VC_APP_NAME           = 'mscripts-dpp-api-gateway'
        VALUES_FILE_PATH      = "charts/eks-deployment/dev.values.yaml"
        SLACK_WEB_HOOK_URL    = credentials('SLACK_WEB_HOOK_URL')
        SLACK_CHANNEL         = "#test-dpp-gateway"
        SLACK_MSG             = ""
        ECR_URL               = "998585994771.dkr.ecr.us-east-1.amazonaws.com"
        SERVICE_IMAGE         = "998585994771.dkr.ecr.us-east-1.amazonaws.com/dpp-mx-gateway:${ENV}-${env.GIT_COMMIT}-${env.BUILD_NUMBER}"
        IMAGE_TAG             = "${ENV}-${env.GIT_COMMIT}-${env.BUILD_NUMBER}"
        BUILD_ID          = "${env.BUILD_ID}"
    }

    stages {
        stage('Source Jenkins Tasks') {
            steps {
                container('dpp-mx-jenkins-iac-agent'){
                    withCredentials([gitUsernamePassword(credentialsId: 'DPP_JENKINS_GITHUB_SECRET_USER', gitToolName: 'Default')]) {
                        sh '''
                            echo 'SETUP JENKINS TASKS RESOURCE FILES..  '
                            /bin/sh jenkins/tasks/setup.sh
                        '''
                    }
                }
            }
        }

        // stage('Run Test Cases') {
        //     steps {
        //         container('dpp-mx-jenkins-app-agent') {
        //             script {
        //                 try {
        //                     sh '''
        //                         echo 'RUNNING UNIT TEST CASES..'
        //                         /bin/sh pipeline-tools-jenkins/jenkins/tasks/test/test.sh
        //                         echo 'UNIT TEST CASES PASSED..'
        //                     '''
        //                 }
        //                 catch (exc) {
        //                     echo 'UNIT TEST CASES FAILED!'
        //                     currentBuild.result = 'FAILURE'
        //                 }
        //             }  
        //         }
        //     }
        // }

        // stage('Build') {
        //     steps {
        //         container('dpp-mx-jenkins-iac-agent') {
        //             script {
        //                 try {
        //                     sh '''
        //                         echo 'INITIATING BUILD..'
        //                         /bin/sh pipeline-tools-jenkins/jenkins/tasks/build/build.sh
        //                     '''
        //                 }
        //                 catch (exc) {
        //                     echo 'BUILD FAILED!'
        //                     currentBuild.result = 'FAILURE'
        //                 }
        //             }
        //         }
        //     }
        // }

        stage('Deploy') {
            steps {
                container('dpp-mx-jenkins-iac-agent') {
                    script {
                        try {
                            sh '''
                                echo 'INITIATING DEPLOYMENT..'
                                /bin/sh pipeline-tools-jenkins/jenkins/tasks/deploy/deploy.sh
                            '''
                        }
                        catch (exc) {
                            echo 'DEPLOYMENT FAILED!'
                            currentBuild.result = 'FAILURE'
                        }
                    }
                }
            }
        }
    }
             
    post {
        always {
            container('dpp-mx-jenkins-app-agent'){
                // sh '''
                // //  echo 'BUILDING JAR/WAR FILE FOR VERACODE SCAN..'
                // //  /bin/sh pipeline-tools-jenkins/jenkins/tasks/veracode/veracode-build.sh
                 
                // //  # To Do - enable sonarqube later
                // //  #echo 'INITIATE SONARQUBE REPORT GENERATION..'
                // //  #/bin/sh pipeline-tools-jenkins/jenkins/tasks/sonar/sonar.sh
                // '''
            } 
            // veracode applicationName: "${VC_APP_NAME}", 
            //                         canFailJob: false, 
            //                         waitForScan: false, 
            //                         criticality: "VeryHigh" , 
            //                         debug: true, 
            //                         deleteIncompleteScanLevel: '1', 
            //                         fileNamePattern: '', 
            //                         replacementPattern: '', 
            //                         sandboxName: '', 
            //                         scanExcludesPattern: '', 
            //                         scanIncludesPattern: '**/**.war, **/**.jar', 
            //                         scanName: '$buildnumber-$timestamp', 
            //                         teams: '', 
            //                         uploadIncludesPattern: 'veracode/**/**.war, veracode/**/**.jar', 
            //                         vid: "${VERACODE_API_ID}", vkey: "${VERACODE_API_KEY}"   
        }
        failure {
                    echo "Running1 ${env.BUILD_ID} on ${env.JENKINS_URL}"

                    sh '''
                        echo 'SEND SLCAK NOTIFICATIONS..'
                        SLACK_MSG="<!here> App: ${PROJECT} Task:  - <https://adc-deployments.infra.remscripts.com/view/DPP-APPOINTMENT-SERVICE-NP/job/DPP-AWS-API-GATEWAY/$buildid/console| Failure>"
                        echo "${SLACK_MSG}"
                        /bin/sh pipeline-tools-jenkins/jenkins/tasks/slack/notification.sh
                    '''
        }
        success {
             echo "Running1 ${env.BUILD_ID} on ${env.JENKINS_URL}"
        }
    }
}

